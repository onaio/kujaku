<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FeatureFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">library</a> &gt; <a href="index.source.html" class="el_package">io.ona.kujaku.utils</a> &gt; <span class="el_source">FeatureFilter.java</span></div><h1>FeatureFilter.java</h1><pre class="source lang-java linenums">package io.ona.kujaku.utils;

import android.support.annotation.NonNull;
import android.support.annotation.Nullable;

import com.mapbox.geojson.Feature;
import com.mapbox.geojson.FeatureCollection;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import io.ona.kujaku.comparisons.Comparison;
import io.ona.kujaku.comparisons.EqualToComparison;
import io.ona.kujaku.comparisons.RegexComparison;

/**
 * Provides the ability to filter locations or features before displaying them on the map. This filter
 * can only perform filter operations on {@link Feature} properties. The operations that can be performed
 * are {@code equalTo} and {@code regex} on {@code {@link String}}. Several conditions can be enforced
 * but only using the {@code and} operator.
 *
 * Example usage:
 * &lt;code&gt;
 *
 *     FeatureFilter.Builder builder = new FeatureFilter.Builder(myFeatureCollection)
 *                                          .whereEq(&quot;propertyName&quot;, &quot;expectedPropertyValue&quot;)
 *                                          .whereEq(&quot;building-type&quot;, &quot;commercial&quot;)
 *                                          .whereRegex(&quot;district&quot;, &quot;(Rungwe|Kilombero|Kyela|Magu|Sikonge|Kasulu)&quot;);
 *     FeatureFilter featureFilter = builder.build();
 *     FeatureCollection filteredFeatureCollection = featureFilter.filter();
 * &lt;/code&gt;
 *
 * Created by Ephraim Kigamba - ekigamba@ona.io on 14/02/2019
 */
public class FeatureFilter {

    private Builder builder;

<span class="fc" id="L40">    private FeatureFilter(@NonNull Builder builder) {</span>
<span class="fc" id="L41">        this.builder = builder;</span>
<span class="fc" id="L42">    }</span>

    public FeatureCollection filter() {
<span class="fc" id="L45">        List&lt;Feature&gt; featuresList = builder.getFeatureCollection().features();</span>
<span class="fc" id="L46">        ArrayList&lt;Feature&gt; filteredFeatures = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L48">        HashMap&lt;String, Comparison&gt; comparisons = new HashMap&lt;&gt;();</span>

<span class="fc" id="L50">        EqualToComparison equalToComparison = new EqualToComparison();</span>
<span class="fc" id="L51">        RegexComparison regexComparison = new RegexComparison();</span>

<span class="fc" id="L53">        comparisons.put(equalToComparison.getFunctionName(), equalToComparison);</span>
<span class="fc" id="L54">        comparisons.put(regexComparison.getFunctionName(), regexComparison);</span>

<span class="pc bpc" id="L56" title="1 of 2 branches missed.">        if (featuresList != null) {</span>
<span class="fc" id="L57">            ArrayList&lt;FilterCondition&gt; filterConditions = builder.getFilterConditions();</span>

<span class="fc bfc" id="L59" title="All 2 branches covered.">            if (filterConditions.size() &gt; 0) {</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">                for (Feature feature : featuresList) {</span>
<span class="fc" id="L61">                    boolean skipFeature = false;</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">                    if (builder.getSortProperty() != null</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">                            &amp;&amp; !feature.hasProperty(builder.getSortProperty())) {</span>
<span class="fc" id="L64">                        continue;</span>
                    }

<span class="fc bfc" id="L67" title="All 2 branches covered.">                    for (FilterCondition filterCondition : filterConditions) {</span>
<span class="fc" id="L68">                        String propertyName = filterCondition.getPropertyName();</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">                        if (feature.hasProperty(propertyName)) {</span>
<span class="fc" id="L70">                            Comparison comparison = comparisons.get(filterCondition.getComparisionType());</span>
<span class="pc bpc" id="L71" title="1 of 4 branches missed.">                            if (comparison != null &amp;&amp; !comparison.compare(</span>
<span class="fc" id="L72">                                    feature.getStringProperty(propertyName),</span>
<span class="fc" id="L73">                                    filterCondition.getValueType(),</span>
<span class="fc" id="L74">                                    (String) filterCondition.getValue())) {</span>
<span class="fc" id="L75">                                skipFeature = true;</span>
<span class="fc" id="L76">                                break;</span>
                            }
<span class="fc" id="L78">                        } else {</span>
<span class="fc" id="L79">                            skipFeature = true;</span>
                        }
<span class="fc" id="L81">                    }</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">                    if (!skipFeature) {</span>
<span class="fc" id="L84">                        filteredFeatures.add(feature);</span>
                    }
<span class="fc" id="L86">                }</span>
            } else {
<span class="fc" id="L88">                filteredFeatures = new ArrayList&lt;&gt;(featuresList);</span>
            }
        }

<span class="fc" id="L92">        return FeatureCollection.fromFeatures(filteredFeatures);</span>
    }

    public FeatureCollection getFeatureCollection() {
<span class="nc" id="L96">        return builder.getFeatureCollection();</span>
    }

    public static class Builder {

        private FeatureCollection featureCollection;
        private String sortProperty;
<span class="fc" id="L103">        private ArrayList&lt;FilterCondition&gt; filterConditions = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L105">        public Builder(@NonNull FeatureCollection featureCollection) {</span>
<span class="fc" id="L106">            this.featureCollection = featureCollection;</span>
<span class="fc" id="L107">        }</span>

        public Builder setSortProperty(@Nullable String sortProperty) {
<span class="fc" id="L110">            this.sortProperty = sortProperty;</span>
<span class="fc" id="L111">            return this;</span>
        }

        public Builder whereEq(@NonNull String property, @NonNull String value) {
<span class="fc" id="L115">            filterConditions.add(new FilterCondition(EqualToComparison.COMPARISON_NAME, property, value, Comparison.TYPE_STRING));</span>
<span class="fc" id="L116">            return this;</span>
        }

        public Builder whereRegex(@NonNull String property, @NonNull String regexPattern) {
<span class="fc" id="L120">            filterConditions.add(new FilterCondition(RegexComparison.COMPARISON_NAME, property, regexPattern, Comparison.TYPE_STRING));</span>
<span class="fc" id="L121">            return this;</span>
        }

        public FeatureCollection getFeatureCollection() {
<span class="fc" id="L125">            return featureCollection;</span>
        }

        public void setFeatureCollection(@NonNull FeatureCollection featureCollection) {
<span class="fc" id="L129">            this.featureCollection = featureCollection;</span>
<span class="fc" id="L130">        }</span>

        @Nullable
        public String getSortProperty() {
<span class="fc" id="L134">            return sortProperty;</span>
        }

        public ArrayList&lt;FilterCondition&gt; getFilterConditions() {
<span class="fc" id="L138">            return filterConditions;</span>
        }

        public FeatureFilter build() {
<span class="fc" id="L142">            return new FeatureFilter(this);</span>
        }
    }

    public static class FilterCondition {
        private String comparisionType;
        private String propertyName;
        private Object value;
        private String valueType;

<span class="fc" id="L152">        public FilterCondition(@NonNull String comparisionType, @NonNull String propertyName, @NonNull Object value, @NonNull String valueType) {</span>
<span class="fc" id="L153">            this.comparisionType = comparisionType;</span>
<span class="fc" id="L154">            this.propertyName = propertyName;</span>
<span class="fc" id="L155">            this.value = value;</span>
<span class="fc" id="L156">            this.valueType = valueType;</span>
<span class="fc" id="L157">        }</span>

        public String getComparisionType() {
<span class="fc" id="L160">            return comparisionType;</span>
        }

        public String getPropertyName() {
<span class="fc" id="L164">            return propertyName;</span>
        }

        public Object getValue() {
<span class="fc" id="L168">            return value;</span>
        }

        public String getValueType() {
<span class="fc" id="L172">            return valueType;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>