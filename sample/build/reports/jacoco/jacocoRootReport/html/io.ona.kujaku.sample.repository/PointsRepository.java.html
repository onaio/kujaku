<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PointsRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sample</a> &gt; <a href="index.source.html" class="el_package">io.ona.kujaku.sample.repository</a> &gt; <span class="el_source">PointsRepository.java</span></div><h1>PointsRepository.java</h1><pre class="source lang-java linenums">package io.ona.kujaku.sample.repository;

import android.util.Log;

import net.sqlcipher.Cursor;
import net.sqlcipher.database.SQLiteDatabase;

import org.apache.commons.lang3.StringUtils;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.List;

import io.ona.kujaku.domain.Point;

import static io.ona.kujaku.sample.util.Constants.INSERT_OR_REPLACE;

/**
 * @author Vincent Karuri
 */
public class PointsRepository extends BaseRepository {

<span class="nc" id="L23">    public static final String TAG = PointsRepository.class.getName();</span>
    public static final String POINTS_TABLE = &quot;points&quot;;
    public static final String ID = &quot;id&quot;;
    public static final String LAT = &quot;lat&quot;;
    public static final String LNG =  &quot;lng&quot;;
    public static final String DATE_UPDATED = &quot;date_updated&quot;;

<span class="nc" id="L30">    public static final String[] POINTS_TABLE_COLUMNS = {ID, LAT, LNG, DATE_UPDATED};</span>

    public static final String CREATE_POINTS_TABLE =

            &quot;CREATE TABLE &quot; + POINTS_TABLE
            + &quot;(&quot;
                    + ID + &quot; INTEGER PRIMARY KEY AUTOINCREMENT,&quot;
                    + LAT + &quot; REAL NOT NULL,&quot;
                    + LNG + &quot; REAL NOT NULL,&quot;
                    + DATE_UPDATED + &quot; INTEGER&quot;
            + &quot;)&quot;;

<span class="nc" id="L42">    public PointsRepository(KujakuRepository repository) { super(repository); }</span>

    public static void createTable(SQLiteDatabase database) {
<span class="nc" id="L45">        database.execSQL(CREATE_POINTS_TABLE);</span>
<span class="nc" id="L46">    }</span>

    public void addOrUpdate(Point point) {

<span class="nc bnc" id="L50" title="All 2 branches missed.">        if (point == null) {</span>
<span class="nc" id="L51">            return;</span>
        }

<span class="nc bnc" id="L54" title="All 2 branches missed.">        if (point.getDateUpdated() == null) {</span>
<span class="nc" id="L55">            point.setDateUpdated(Calendar.getInstance().getTimeInMillis());</span>
        }

        try {
<span class="nc" id="L59">            SQLiteDatabase database = getWritableDatabase();</span>

<span class="nc" id="L61">            String query = String.format(INSERT_OR_REPLACE, POINTS_TABLE);</span>
<span class="nc" id="L62">            query += &quot;(&quot; + StringUtils.repeat(&quot;?&quot;, &quot;,&quot;, POINTS_TABLE_COLUMNS.length) + &quot;)&quot;;</span>
<span class="nc" id="L63">            database.execSQL(query, createQueryValues(point));</span>
<span class="nc" id="L64">        } catch (Exception e) {</span>
<span class="nc" id="L65">            Log.e(TAG, Log.getStackTraceString(e));</span>
<span class="nc" id="L66">        }</span>
<span class="nc" id="L67">    }</span>

    public List&lt;Point&gt; getAllPoints() {

<span class="nc" id="L71">        List&lt;Point&gt; points = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L72">        Cursor cursor = null;</span>
        try {
<span class="nc" id="L74">            cursor = getReadableDatabase().rawQuery(&quot;SELECT * &quot; + &quot; FROM &quot; +  POINTS_TABLE, null);</span>
<span class="nc" id="L75">            points = readPoints(cursor);</span>
<span class="nc" id="L76">        } catch (Exception e) {</span>
<span class="nc" id="L77">            Log.e(TAG, Log.getStackTraceString(e));</span>
        } finally {
<span class="nc bnc" id="L79" title="All 6 branches missed.">            if (cursor != null) {</span>
<span class="nc" id="L80">                cursor.close();</span>
            }
<span class="nc" id="L82">        }</span>
<span class="nc" id="L83">        return points;</span>
    }

    public Point getPoint(String id) {
<span class="nc" id="L87">        Point point = null;</span>
<span class="nc" id="L88">        Cursor cursor = null;</span>
        try {
<span class="nc" id="L90">            cursor = getReadableDatabase().rawQuery(&quot;SELECT * &quot; + &quot; FROM &quot; + POINTS_TABLE + &quot; WHERE &quot; + ID + &quot;=?&quot;, new String[]{id});</span>
<span class="nc" id="L91">            List&lt;Point&gt; points = readPoints(cursor);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            point = points.size() &gt; 0 ? points.get(0) : null;</span>
<span class="nc" id="L93">        } catch (Exception e) {</span>
<span class="nc" id="L94">            Log.e(TAG, Log.getStackTraceString(e));</span>
        } finally {
<span class="nc bnc" id="L96" title="All 6 branches missed.">            if (cursor != null) {</span>
<span class="nc" id="L97">                cursor.close();</span>
            }
<span class="nc" id="L99">        }</span>
<span class="nc" id="L100">        return point;</span>
    }

    private List&lt;Point&gt; readPoints(Cursor cursor) {

<span class="nc" id="L105">        List&lt;Point&gt; points = new ArrayList&lt;&gt;();</span>
        try {
<span class="nc bnc" id="L107" title="All 6 branches missed.">            if (cursor != null &amp;&amp; cursor.getCount() &gt; 0 &amp;&amp; cursor.moveToFirst()) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                while (!cursor.isAfterLast()) {</span>
<span class="nc" id="L109">                    points.add(createPoint(cursor));</span>
<span class="nc" id="L110">                    cursor.moveToNext();</span>
                }
            }
<span class="nc" id="L113">        } catch (Exception e) {</span>
<span class="nc" id="L114">            Log.e(TAG, Log.getStackTraceString(e));</span>
        } finally {
<span class="nc bnc" id="L116" title="All 6 branches missed.">            if (cursor != null) {</span>
<span class="nc" id="L117">                cursor.close();</span>
            }
<span class="nc" id="L119">        }</span>
<span class="nc" id="L120">        return points;</span>
    }

    private Point createPoint(Cursor cursor) {
<span class="nc" id="L124">        return new Point(</span>
<span class="nc" id="L125">                cursor.getInt(cursor.getColumnIndex(ID)),</span>
<span class="nc" id="L126">                cursor.getDouble(cursor.getColumnIndex(LAT)),</span>
<span class="nc" id="L127">                cursor.getDouble(cursor.getColumnIndex(LNG))</span>
        );
    }

    private Object[] createQueryValues(Point point) {
<span class="nc" id="L132">        Object[] values = new Object[]{</span>
<span class="nc" id="L133">                point.getId(),</span>
<span class="nc" id="L134">                point.getLat(),</span>
<span class="nc" id="L135">                point.getLng(),</span>
<span class="nc" id="L136">                point.getDateUpdated()</span>
        };
<span class="nc" id="L138">        return values;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>